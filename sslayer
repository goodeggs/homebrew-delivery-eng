#!/bin/sh
set -e
# set -x

main() {
  [ "$(id -u)" -eq 0 ] || die "must be run as root"

  mkdir -p /Library/Application\ Support/sslayer
  cd /Library/Application\ Support/sslayer || exit 1

  case "$1" in
    setup) setup ;;
    start) server "$2" ;;
    *) die "usage: slayer [setup | server path/to/nginx]" ;;
  esac
}

die() {
  echo "$*"
  exit 1
}

setup() {
  if [ ! -r cert.pem ]; then
    echo "Generating *.goodeggs.localhost wildcard cert:"
  cat > openssl.conf <<EOF
[ req ]
distinguished_name = subject
req_extensions      = req_ext
x509_extensions     = x509_ext

[ subject ]
countryName = Country Name (2-letter code)
countryName_default = US
stateOrProvinceName = State or Province Name (full name)
stateOrProvinceName_default = California
localityName = Locality Name (e.g. city)
localityName_default = San Francisco
organizationName = Organization Name
organizationName_default = Good Eggs
organizationalUnitName = Organization Unit
organizationalUnitName_default = Local Development
commonName = Common Name
commonName_default = *.goodeggs.localhost

[ req_ext ]
subjectAltName = @alternate_names

[ x509_ext ]
subjectAltName = @alternate_names

[ alternate_names ]
DNS.1 = *.goodeggs.localhost
EOF
    openssl req -batch -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 3650 -sha256 -nodes -config openssl.conf | sed 's//    /'
    echo ""
    echo "Now, I will open $PWD/cert.pem in Keychain Access, and you need to make sure SSL is set to Always Trust."
    printf "Ready? [Y] "
    read -r
    open cert.pem
  else
    die "$PWD/cert.pem already exists.  You only need to do this setup once per machine.  Delete $PWD and re-run if you really want to re-install."
  fi
}

server() {
  path_to_nginx="$1"

  MAPPINGS=$(cat <<EOF
api.goodeggs.localhost:3000
www.goodeggs.localhost:3000
mobile-api.goodeggs.localhost:3003
manage.goodeggs.localhost:3010
ops.goodeggs.localhost:8000
ops-employees.goodeggs.localhost:8005
employees.goodeggs.localhost:8005
ops-employees-api.goodeggs.localhost:8010
employees-api.goodeggs.localhost:8010
ops-purchase-orders.goodeggs.localhost:8025
purchase-orders.goodeggs.localhost:8025
ops-purchase-orders-api.goodeggs.localhost:8030
purchase-orders-api.goodeggs.localhost:8030
inventory-api.goodeggs.localhost:8040
inventory.goodeggs.localhost:8045
customers-api.goodeggs.localhost:8050
availability-api.goodeggs.localhost:8060
domain-events.goodeggs.localhost:9000
demand-prediction-api.goodeggs.localhost:8090
pick-api.goodeggs.localhost:9010
shipping-api.goodeggs.localhost:9020
fulfillment.goodeggs.localhost:9030
fulfillment-options-api.goodeggs.localhost:9040
it-accounts-ui.goodeggs.localhost:9050
it-accounts-api.goodeggs.localhost:9060
pick-triage-api.goodeggs.localhost:9070
pick-triage.goodeggs.localhost:9075
gather.goodeggs.localhost:9085
devices.goodeggs.localhost:9095
merchandising.goodeggs.localhost:9100
catalog-api.goodeggs.localhost:9130
EOF
)

  cat > nginx.conf <<EOF
daemon off;
worker_processes auto;

events {
    worker_connections  1024;
}

http {
    default_type  application/octet-stream;

    ssl_certificate     "$PWD/cert.pem";
    ssl_certificate_key "$PWD/key.pem";

    server {
    	listen 80 default_server;
    	server_name _;
    	return 301 https://\$host\$request_uri;
    }
EOF

  idx=0
  for entry in $MAPPINGS; do
    idx=$((idx + 1))
    hostname=$(echo "$entry" | awk -F: '{print $1}')
    port=$(echo "$entry" | awk -F: '{print $2}')

    cat >> nginx.conf <<EOF

    upstream u${idx} {
        server 127.0.0.1:${port};
    }

    server {
        listen 443 ssl;
        server_name ${hostname};
        location / {
            proxy_pass http://u${idx};
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto \$scheme;
            proxy_set_header Fastly-SSL 1;
        }
    }
EOF
  done

  echo '}' >> nginx.conf

  echo "starting nginx!"
  exec "$path_to_nginx" -c "$PWD/nginx.conf"
}

main "$@"
